这篇文章主要用于学习分布式系统，所以内容都是源自网络或书籍当中，具体参见后面的参考文档。

## 数据复制与一致性

### 设计理念
#### CAP、ACID、BASE原则

#### 幂等性(Idempotent)
数学中的幂等性，如`f(x) = x`，得出`f(f(x)) = f(x)`，把满足这种条件的运算称为幂等性。类似于二元函数`f(x, x) = x`，也称为幂等性。将这种思想运用在分布式系统当中，幂等性是指：调用方反复执行同一种操作，与只正确执行一次达到的效果相同。也就是说，同一操作调用一次与反复调用多次其状态相同。幂等性在分布式环境下很重要，因为分布式环境下调用方和被调用方往往需要通过网络通信，如果调用方已经正确调用服务方提供的功能，但由于网络故障，调用方未收到调用成功的响应，会认为调用失败而再次调用相同的操作。这样被调用方会反复执行同一个操作。此种情况下，保持幂等性，以保证系统状态的正确性。

### 副本更新策略

一份数据在系统内存在多份，并存储与不同的机器中，

优势：

一方面通过冗余数据增加系统的可用性，另一方面可以增加等操作的并发程度。

劣势：

带来数据的一致性问题。

#### 副本更新策略
##### 同时更新策略
  * 直接更新策略，即不采用任何一致性更新协议，对存在的多个数据副本，直接进行同时更新。
> 存在的问题：副本对更新指令的顺序问题。如果不同客户端，同一时刻发出了对一份数据的更新请求，记为Q1和Q2，就会存在有些副本先更新Q1，再是Q2，而有些副本则相反。

  * 采用某种一致性协议预先处理，可以保证不同更新指令的执行顺序，从而保证唯一性。但也同时，带来了请求延时的问题。
  
**思考**：两种不同的更新策略，都是在`低请求延时`及`副本数据的一致性`之间作出权衡。那么是否存在某种两全其美的更新策略呢？我们继续往后看

##### 主从式更新策略
`主从`指的是，将某数据的多个副本，分成主从两类。一般而言，一个主副本(Master Replica)，对应多个从副本。对这种主从副本的更新，成为主从式更新策略。所有对这个数据的更新，都先交给主副本，再由主副本通知从副本进行数据更新。如果同时产生多个数据更新操作，则由主副本决定不同的更新顺序，从副本则遵循主副本的更新顺序。以下是两种不同的主从更新策略。
  * 同步方式。主副本等待所有从副本更新完成之后，才确认更关心操作完成。确保了数据的**强**一致性。但这同时带来了较大的请求延时，尤其在多副本跨数据中心的情形下。问题就在于请求延时是由更新最慢的那个副本所决定的。
  * 异步方式。主副本在通知从副本更新之前，即可确认更新操作。存在的问题，就是这种场景下，假设副本还没有通知任何其它从副本就发生崩溃，就会带来数据一致性的问题。所以会首先在另外的可靠位置将这次更新操作记录下来。
  * 混合方式，即同步方式与异步方式混合。即主副本首先更新部分从副本数据，然后确认更新操作完成，然后再以异步的方式更新剩余的副本。

**总结**，可见，主从式副本更新策略，在进行副本更新操作的时候，主副本作为更新的发起点。

##### 任意节点更新策略
对比着**主从式更新策略**来看，这种策略区分主从的概念，任意节点接收到更新请求后，都可以响应。所以存在的问题和上面的**同时更新策略**存在的问题相似，就是两个不同的副本接收到数据更新请求后，各自响应。

这种情况下，请求延时和一致性的权衡有以下两种可能的情形。
  * 情形一，同步通知其它副本。这种情形，就和上面的**主从式更新策略**中，同步更新方式相近。但需要确保，当两个副本同时接到更新请求时，如何处理。所以，需要付出相对多的请求延时。
  * 情形二，异步通知其它副本。同理，和上面的异步更新方式相近。

### 参考文档
